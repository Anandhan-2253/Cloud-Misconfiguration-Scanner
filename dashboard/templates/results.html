{% extends "base.html" %}
{% from "partials/macros.html" import risk_badge, service_badge %}

{% block content %}
<section class="flex items-start justify-between gap-6 mb-8">
    <div>
        <h1 class="text-2xl font-semibold tracking-tight">Results Dashboard</h1>
        <p class="text-muted mt-1">SOC-style risk posture and findings triage.</p>
    </div>
    <div class="glass-panel px-4 py-3 rounded-lg text-right">
        <div class="text-xs uppercase text-muted tracking-wide">Last scan</div>
        <div class="mono text-sm">{{ timestamp or "No scans recorded" }}</div>
    </div>
</section>

{% if empty_state %}
<section class="glass-panel rounded-2xl p-6 shadow-soc">
    <h2 class="text-lg font-semibold">No Scan Data Yet</h2>
    <p class="text-muted mt-2">Run a scan to populate findings, heatmaps, and remediation guidance.</p>
    <a href="{{ url_for('index') }}" class="inline-flex mt-4 px-4 py-2 rounded-lg bg-ink text-[#0f172a] font-semibold">Start a Scan</a>
</section>
{% else %}
<section class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
    <div class="glass-panel rounded-xl p-4 shadow-soc fade-in">
        <div class="text-xs uppercase text-muted tracking-widest">Total Findings</div>
        <div class="text-2xl font-semibold mono mt-2">{{ findings | length }}</div>
        <div class="text-xs text-muted mt-1">Across IAM, Storage, Network</div>
    </div>
    <div class="glass-panel rounded-xl p-4 shadow-soc fade-in">
        <div class="text-xs uppercase text-muted tracking-widest">Critical Risks</div>
        <div class="text-2xl font-semibold mono mt-2 text-critical">{{ summary.counts["Critical"] }}</div>
        <div class="text-xs text-muted mt-1">Immediate remediation</div>
    </div>
    <div class="glass-panel rounded-xl p-4 shadow-soc fade-in">
        <div class="text-xs uppercase text-muted tracking-widest">High Risks</div>
        <div class="text-2xl font-semibold mono mt-2 text-high">{{ summary.counts["High"] }}</div>
        <div class="text-xs text-muted mt-1">Prioritize this sprint</div>
    </div>
    <div class="glass-panel rounded-xl p-4 shadow-soc fade-in">
        <div class="text-xs uppercase text-muted tracking-widest">Overall Risk Score</div>
        <div class="text-2xl font-semibold mono mt-2">{{ posture[1] }}</div>
        <div class="text-xs text-muted mt-1">{{ posture[0] }} posture</div>
    </div>
</section>

<section class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-8">
    <div class="glass-panel rounded-2xl p-5 shadow-soc xl:col-span-2">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h2 class="text-lg font-semibold">Risk Heatmap</h2>
                <p class="text-muted text-sm">Likelihood vs. impact grid with analyst cues.</p>
            </div>
            <div class="flex items-center gap-2 text-xs text-muted mono">
                <span class="w-2 h-2 rounded-full bg-critical"></span> Critical
                <span class="w-2 h-2 rounded-full bg-high"></span> High
                <span class="w-2 h-2 rounded-full bg-medium"></span> Medium
                <span class="w-2 h-2 rounded-full bg-low"></span> Low
            </div>
        </div>
        <div class="grid grid-cols-[40px_repeat(3,minmax(0,1fr))] gap-2">
            <div></div>
            {% for label in heatmap.labels %}
                <div class="text-xs text-muted text-center uppercase tracking-widest">{{ label }}</div>
            {% endfor %}
            {% for impact in heatmap.labels %}
                <div class="text-xs text-muted text-right uppercase tracking-widest pr-2">{{ impact }}</div>
                {% for likelihood in heatmap.labels %}
                    {% for cell in heatmap.cells if cell.impact == impact and cell.likelihood == likelihood %}
                        <div class="heat-cell border border-border rounded-lg h-24 flex flex-col items-center justify-center text-sm mono cursor-pointer bg-panel"
                             data-risk="{{ cell.risk }}"
                             data-example="{{ cell.example }}"
                             data-count="{{ cell.count }}"
                             data-impact="{{ cell.impact }}"
                             data-likelihood="{{ cell.likelihood }}">
                            <div class="text-lg font-semibold">{{ cell.count }}</div>
                            <div class="text-[11px] text-muted">Findings</div>
                        </div>
                    {% endfor %}
                {% endfor %}
            {% endfor %}
        </div>
        <div class="text-xs text-muted mt-3 flex justify-between">
            <span>Impact (Low → High)</span>
            <span>Likelihood (Low → High)</span>
        </div>
    </div>

    <div class="glass-panel rounded-2xl p-5 shadow-soc">
        <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">Risk Distribution</h2>
            <span class="text-xs text-muted mono">Latest scan</span>
        </div>
        <canvas id="riskChart" class="mt-4" height="180"
                data-critical="{{ summary.counts["Critical"] }}"
                data-high="{{ summary.counts["High"] }}"
                data-medium="{{ summary.counts["Medium"] }}"
                data-low="{{ summary.counts["Low"] }}"></canvas>
        <div class="mt-5 space-y-2 text-sm mono">
            <div class="flex items-center justify-between">
                <span class="text-muted">IAM Findings</span>
                <span>{{ summary.by_service["IAM"] }}</span>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-muted">Storage Findings</span>
                <span>{{ summary.by_service["Storage"] }}</span>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-muted">Network Findings</span>
                <span>{{ summary.by_service["Network"] }}</span>
            </div>
        </div>
        <div class="mt-4 text-xs text-muted">Report: <a class="underline" href="{{ url_for('report', filename=report_name) }}">Download HTML</a></div>
    </div>
</section>

<section class="glass-panel rounded-2xl p-5 shadow-soc">
    <div class="flex items-center justify-between mb-4">
        <div>
            <h2 class="text-lg font-semibold">Findings Table</h2>
            <p class="text-muted text-sm">Sorted by fix priority and risk category.</p>
        </div>
        <div class="text-xs text-muted mono">Last scan completed at {{ timestamp }}</div>
    </div>

    {% if errors %}
        <div class="border border-border rounded-lg p-3 text-sm text-muted mb-4">
            <span class="text-ink font-semibold">Parse warnings:</span>
            {% for err in errors %}
                <div class="mono text-xs mt-1">{{ err }}</div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="overflow-auto scrollbar-thin">
        <table class="w-full text-sm border-separate border-spacing-0">
            <thead class="sticky top-0 bg-[#0b1220]">
                <tr>
                    <th class="text-left p-3 text-xs uppercase tracking-widest text-muted border-b border-border">Priority</th>
                    <th class="text-left p-3 text-xs uppercase tracking-widest text-muted border-b border-border">Finding</th>
                    <th class="text-left p-3 text-xs uppercase tracking-widest text-muted border-b border-border">Risk</th>
                    <th class="text-left p-3 text-xs uppercase tracking-widest text-muted border-b border-border">Service</th>
                    <th class="text-left p-3 text-xs uppercase tracking-widest text-muted border-b border-border">Score</th>
                    <th class="text-left p-3 text-xs uppercase tracking-widest text-muted border-b border-border">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for f in findings %}
                <tr class="border-b border-border">
                    <td class="p-3 mono">{{ f.fix_priority }}</td>
                    <td class="p-3">
                        <div class="font-semibold">{{ f.title }}</div>
                        <div class="text-xs text-muted mono">{{ f.resource_type }}::{{ f.resource_id }}</div>
                    </td>
                    <td class="p-3">{{ risk_badge(f.risk_category) }}</td>
                    <td class="p-3">{{ service_badge(f.service) }}</td>
                    <td class="p-3 mono">{{ f.risk_score }}</td>
                    <td class="p-3">
                        <button class="text-xs underline text-muted mono toggle-row" data-target="detail-{{ loop.index }}">View</button>
                    </td>
                </tr>
                <tr id="detail-{{ loop.index }}" class="hidden bg-[#0b1220] border-b border-border">
                    <td colspan="6" class="p-4">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 text-sm">
                            <div>
                                <div class="text-xs text-muted uppercase tracking-widest">Why this matters</div>
                                <p class="mt-2 text-sm text-muted">{{ f.description }}</p>
                            </div>
                            <div>
                                <div class="text-xs text-muted uppercase tracking-widest">Attack scenario</div>
                                <p class="mt-2 text-sm text-muted">Exploit path aligns with {{ f.likelihood_factors.common_attack_pattern | default("medium") | capitalize }}-frequency attacker behavior and {{ f.likelihood_factors.ease_of_exploit | default("moderate") }} exploitation effort.</p>
                            </div>
                            <div>
                                <div class="text-xs text-muted uppercase tracking-widest">Recommended fix</div>
                                <p class="mt-2 text-sm text-muted">{{ f.remediation }}</p>
                            </div>
                        </div>
                        <div class="mt-3 grid grid-cols-1 lg:grid-cols-3 gap-3 text-xs">
                            <div class="text-muted mono">Impact: {{ f.impact_factors }}</div>
                            <div class="text-muted mono">Likelihood: {{ f.likelihood_factors }}</div>
                            <div class="text-muted mono">Compliance: CIS {{ f.cis | join(", ") }} | OWASP {{ f.owasp | join(", ") }} | MITRE {{ f.mitre | join(", ") }}</div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endif %}
{% endblock %}
